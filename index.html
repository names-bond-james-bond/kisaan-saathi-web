<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="website-title">Kisaan Saathi</title>
    <!-- Use Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a Google Font for better aesthetics -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        .container {
            max-width: 800px;
        }
        /* Custom scrollbar for the results section */
        .results-section::-webkit-scrollbar {
            width: 8px;
        }
        .results-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .results-section::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        .results-section::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white rounded-xl shadow-lg p-8 w-full">
        <!-- Language Selection -->
        <div class="flex justify-end space-x-2 mb-4">
            <button id="lang-en" class="text-sm px-3 py-1 rounded-lg border border-gray-300 bg-gray-200 text-gray-700 font-medium">EN</button>
            <button id="lang-hi" class="text-sm px-3 py-1 rounded-lg border border-gray-300 text-gray-700 font-medium">HI</button>
            <button id="lang-gu" class="text-sm px-3 py-1 rounded-lg border border-gray-300 text-gray-700 font-medium">GU</button>
        </div>

        <header class="text-center mb-8">
            <h1 id="main-title" class="text-4xl font-bold text-gray-800">ðŸŒ± Farmer's Agri-Hub (Gujarat)</h1>
            <p id="main-subtitle" class="text-gray-600 mt-2">Select your district to get personalized agricultural advice.</p>
        </header>

        <!-- Input Form for Pincode and District -->
        <form id="location-form" class="flex flex-col sm:flex-row gap-4 mb-8">
            <select id="district" required
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <option value="" disabled selected>Select a District</option>
                <option value="ahmedabad">Ahmedabad</option>
                <option value="amreli">Amreli</option>
                <option value="anand">Anand</option>
                <option value="aravalli">Aravalli</option>
                <option value="banaskantha">Banaskantha</option>
                <option value="bharuch">Bharuch</option>
                <option value="bhavnagar">Bhavnagar</option>
                <option value="botad">Botad</option>
                <option value="chhota udaipur">Chhota Udaipur</option>
                <option value="dahod">Dahod</option>
                <option value="dang">Dang</option>
                <option value="devbhoomi dwarka">Devbhoomi Dwarka</option>
                <option value="gandhinagar">Gandhinagar</option>
                <option value="gir somnath">Gir Somnath</option>
                <option value="jamnagar">Jamnagar</option>
                <option value="junagadh">Junagadh</option>
                <option value="kheda">Kheda</option>
                <option value="kutch">Kutch</option>
                <option value="mahesana">Mahesana</option>
                <option value="mahisagar">Mahisagar</option>
                <option value="morbi">Morbi</option>
                <option value="narmada">Narmada</option>
                <option value="navsari">Navsari</option>
                <option value="panchmahal">Panchmahal</option>
                <option value="patan">Patan</option>
                <option value="porbandar">Porbandar</option>
                <option value="rajkot">Rajkot</option>
                <option value="sabarkantha">Sabarkantha</option>
                <option value="surat">Surat</option>
                <option value="surendranagar">Surendranagar</option>
                <option value="tapi">Tapi</option>
                <option value="vadodara">Vadodara</option>
                <option value="valsad">Valsad</option>
            </select>
            <button type="submit" id="get-info-btn"
                    class="bg-green-600 text-white font-semibold p-3 rounded-lg hover:bg-green-700 transition duration-300">
                Get Info
            </button>
        </form>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden text-center text-gray-500">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-gray-300 border-t-green-500 rounded-full"></div>
            <p id="loading-text" class="mt-2">Fetching data...</p>
        </div>

        <!-- Results Display -->
        <div id="results" class="hidden">
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner results-section overflow-y-auto max-h-[40vh]">
                <!-- Section for Crop Recommendations -->
                <section class="mb-6">
                    <h2 id="plants-heading" class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">Recommended Plants</h2>
                    <div id="plant-info" class="text-gray-600 space-y-2"></div>
                </section>

                <!-- Section for Soil Nutrients -->
                <section class="mb-6">
                    <h2 id="nutrients-heading" class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">Soil Nutrients</h2>
                    <div id="nutrient-info" class="text-gray-600 space-y-2"></div>
                </section>

                <!-- Section for Weather and Disaster Alerts -->
                <section>
                    <h2 id="alerts-heading" class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">Weather & Disaster Alerts</h2>
                    <div id="alert-info" class="text-gray-600 space-y-2"></div>
                </section>
            </div>
        </div>

        <!-- Ask an Expert Section -->
        <section class="mt-8">
            <h2 id="expert-heading" class="text-2xl font-bold text-gray-800 mb-4 text-center">ðŸ¤– Ask an Expert</h2>
            <p id="expert-subtitle" class="text-gray-600 text-center mb-4">Ask any agriculture-related question and get advice from our AI expert. Responses are powered by the Gemini model.</p>
            <div class="flex flex-col gap-4">
                <textarea id="user-question" rows="4" placeholder="e.g., How can I improve my soil's nitrogen content naturally?"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                <button id="ask-button"
                        class="bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 transition duration-300">
                    Ask
                </button>
            </div>
            <div id="gemini-response" class="bg-gray-50 p-6 rounded-lg shadow-inner mt-4 min-h-[100px] hidden">
                <p id="gemini-text" class="text-gray-700 leading-relaxed"></p>
                <div id="gemini-loading" class="hidden text-center text-gray-500 mt-4">
                    <div class="animate-spin inline-block w-6 h-6 border-4 border-gray-300 border-t-blue-500 rounded-full"></div>
                </div>
            </div>
        </section>

        <!-- Error/Message Box -->
        <div id="message-box" class="hidden p-4 mt-4 text-center rounded-lg"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get all the necessary DOM elements
            const form = document.getElementById('location-form');
            const districtInput = document.getElementById('district');
            const loadingIndicator = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const plantInfoDiv = document.getElementById('plant-info');
            const nutrientInfoDiv = document.getElementById('nutrient-info');
            const alertInfoDiv = document.getElementById('alert-info');
            const messageBox = document.getElementById('message-box');
            const websiteTitle = document.getElementById('website-title');
            
            // New elements for LLM functionality
            const userQuestionTextarea = document.getElementById('user-question');
            const askButton = document.getElementById('ask-button');
            const geminiResponseDiv = document.getElementById('gemini-response');
            const geminiTextP = document.getElementById('gemini-text');
            const geminiLoadingDiv = document.getElementById('gemini-loading');

            // Language selection buttons
            const langEnBtn = document.getElementById('lang-en');
            const langHiBtn = document.getElementById('lang-hi');
            const langGuBtn = document.getElementById('lang-gu');
            
            // Define a translation object for all UI text
            const translations = {
                en: {
                    websiteTitle: "Kisaan Saathi",
                    mainTitle: "ðŸŒ± Kisaan Saathi (Gujarat)",
                    mainSubtitle: "Select your district to get personalized agricultural advice.",
                    districtPlaceholder: "Select a District",
                    getInfoBtn: "Get Info",
                    loadingText: "Fetching data...",
                    plantsHeading: "Recommended Plants",
                    nutrientsHeading: "Soil Nutrients",
                    alertsHeading: "Weather & Disaster Alerts",
                    expertHeading: "ðŸ¤– Ask an Expert",
                    expertSubtitle: "Ask any agriculture-related question and get advice from our AI expert. Responses are powered by the Gemini model.",
                    questionPlaceholder: "e.g., How can I improve my soil's nitrogen content naturally?",
                    askBtn: "Ask",
                    selectDistrictError: "Please select a district.",
                    fetchError: "Sorry, an error occurred while fetching agricultural data. Please try again later.",
                    askError: "Please enter a question and select a district.",
                    geminiError: "Sorry, I am unable to provide a response at this time. Please try again later.",
                    expertAdvicePrefix: "Expert Advice:"
                },
                hi: {
                    websiteTitle: "à¤•à¤¿à¤¸à¤¾à¤¨ à¤¸à¤¾à¤¥à¥€",
                    mainTitle: "ðŸŒ± à¤•à¤¿à¤¸à¤¾à¤¨ à¤¸à¤¾à¤¥à¥€ (à¤—à¥à¤œà¤°à¤¾à¤¤)",
                    mainSubtitle: "à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤ à¤•à¥ƒà¤·à¤¿ à¤¸à¤²à¤¾à¤¹ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤ªà¤¨à¤¾ à¤œà¤¿à¤²à¤¾ à¤šà¥à¤¨à¥‡à¤‚à¥¤",
                    districtPlaceholder: "à¤à¤• à¤œà¤¿à¤²à¤¾ à¤šà¥à¤¨à¥‡à¤‚",
                    getInfoBtn: "à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¥‡à¤‚",
                    loadingText: "à¤¡à¥‡à¤Ÿà¤¾ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
                    plantsHeading: "à¤…à¤¨à¥à¤¶à¤‚à¤¸à¤¿à¤¤ à¤ªà¥Œà¤§à¥‡",
                    nutrientsHeading: "à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤•à¥‡ à¤ªà¥‹à¤·à¤• à¤¤à¤¤à¥à¤µ",
                    alertsHeading: "à¤®à¥Œà¤¸à¤® à¤”à¤° à¤†à¤ªà¤¦à¤¾ à¤…à¤²à¤°à¥à¤Ÿ",
                    expertHeading: "ðŸ¤– à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ž à¤¸à¥‡ à¤ªà¥‚à¤›à¥‡à¤‚",
                    expertSubtitle: "à¤•à¥‹à¤ˆ à¤­à¥€ à¤•à¥ƒà¤·à¤¿-à¤¸à¤‚à¤¬à¤‚à¤§à¥€ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚ à¤”à¤° à¤¹à¤®à¤¾à¤°à¥‡ AI à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ž à¤¸à¥‡ à¤¸à¤²à¤¾à¤¹ à¤²à¥‡à¤‚à¥¤ à¤ªà¥à¤°à¤¤à¤¿à¤•à¥à¤°à¤¿à¤¯à¤¾à¤à¤‚ à¤œà¥‡à¤®à¤¿à¤¨à¥€ à¤®à¥‰à¤¡à¤² à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤¸à¤‚à¤šà¤¾à¤²à¤¿à¤¤ à¤¹à¥ˆà¤‚à¥¤",
                    questionPlaceholder: "à¤‰à¤¦à¤¾à¤¹à¤°à¤£ à¤•à¥‡ à¤²à¤¿à¤, à¤®à¥ˆà¤‚ à¤…à¤ªà¤¨à¥€ à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ à¤•à¥€ à¤¨à¤¾à¤‡à¤Ÿà¥à¤°à¥‹à¤œà¤¨ à¤¸à¤¾à¤®à¤—à¥à¤°à¥€ à¤•à¥‹ à¤ªà¥à¤°à¤¾à¤•à¥ƒà¤¤à¤¿à¤• à¤°à¥‚à¤ª à¤¸à¥‡ à¤•à¥ˆà¤¸à¥‡ à¤¸à¥à¤§à¤¾à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?",
                    askBtn: "à¤ªà¥‚à¤›à¥‡à¤‚",
                    selectDistrictError: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤• à¤œà¤¿à¤²à¤¾ à¤šà¥à¤¨à¥‡à¤‚à¥¤",
                    fetchError: "à¤•à¥à¤·à¤®à¤¾ à¤•à¤°à¥‡à¤‚, à¤•à¥ƒà¤·à¤¿ à¤¡à¥‡à¤Ÿà¤¾ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¤¤à¥‡ à¤¸à¤®à¤¯ à¤à¤• à¤¤à¥à¤°à¥à¤Ÿà¤¿ à¤¹à¥à¤ˆà¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¬à¤¾à¤¦ à¤®à¥‡à¤‚ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
                    askError: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤• à¤ªà¥à¤°à¤¶à¥à¤¨ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚ à¤”à¤° à¤à¤• à¤œà¤¿à¤²à¤¾ à¤šà¥à¤¨à¥‡à¤‚à¥¤",
                    geminiError: "à¤•à¥à¤·à¤®à¤¾ à¤•à¤°à¥‡à¤‚, à¤®à¥ˆà¤‚ à¤‡à¤¸ à¤¸à¤®à¤¯ à¤•à¥‹à¤ˆ à¤ªà¥à¤°à¤¤à¤¿à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤¨à¤¹à¥€à¤‚ à¤¦à¥‡ à¤ªà¤¾ à¤°à¤¹à¤¾ à¤¹à¥‚à¤à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¬à¤¾à¤¦ à¤®à¥‡à¤‚ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
                    expertAdvicePrefix: "à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ž à¤•à¥€ à¤¸à¤²à¤¾à¤¹:"
                },
                gu: {
                    websiteTitle: "àª•àª¿àª¸àª¾àª¨ àª¸àª¾àª¥à«€",
                    mainTitle: "ðŸŒ± àª•àª¿àª¸àª¾àª¨ àª¸àª¾àª¥à«€ (àª—à«àªœàª°àª¾àª¤)",
                    mainSubtitle: "àªµà«àª¯àª•à«àª¤àª¿àª—àª¤ àª•à«ƒàª·àª¿ àª¸àª²àª¾àª¹ àª®à«‡àª³àªµàªµàª¾ àª®àª¾àªŸà«‡ àª¤àª®àª¾àª°à«‹ àªœàª¿àª²à«àª²à«‹ àªªàª¸àª‚àª¦ àª•àª°à«‹.",
                    districtPlaceholder: "àªàª• àªœàª¿àª²à«àª²à«‹ àªªàª¸àª‚àª¦ àª•àª°à«‹",
                    getInfoBtn: "àª®àª¾àª¹àª¿àª¤à«€ àª®à«‡àª³àªµà«‹",
                    loadingText: "àª¡à«‡àªŸàª¾ àª®à«‡àª³àªµà«€ àª°àª¹à«àª¯à«àª‚ àª›à«‡...",
                    plantsHeading: "àª­àª²àª¾àª®àª£ àª•àª°à«‡àª² àª›à«‹àª¡",
                    nutrientsHeading: "àªœàª®à«€àª¨àª¨àª¾ àªªà«‹àª·àª• àª¤àª¤à«àªµà«‹",
                    alertsHeading: "àª¹àªµàª¾àª®àª¾àª¨ àª…àª¨à«‡ àª†àªªàª¤à«àª¤àª¿ àªšà«‡àª¤àªµàª£à«€àª“",
                    expertHeading: "ðŸ¤– àª¨àª¿àª·à«àª£àª¾àª¤àª¨à«‡ àªªà«‚àª›à«‹",
                    expertSubtitle: "àª•à«‹àªˆàªªàª£ àª•à«ƒàª·àª¿-àª¸àª‚àª¬àª‚àª§àª¿àª¤ àªªà«àª°àª¶à«àª¨ àªªà«‚àª›à«‹ àª…àª¨à«‡ àª…àª®àª¾àª°àª¾ AI àª¨àª¿àª·à«àª£àª¾àª¤ àªªàª¾àª¸à«‡àª¥à«€ àª¸àª²àª¾àª¹ àª®à«‡àª³àªµà«‹. àªªà«àª°àª¤àª¿àª­àª¾àªµà«‹ àªœà«‡àª®àª¿àª¨à«€ àª®à«‹àª¡à«‡àª² àª¦à«àªµàª¾àª°àª¾ àª¸àª‚àªšàª¾àª²àª¿àª¤ àª›à«‡.",
                    questionPlaceholder: "àª¦àª¾.àª¤., àª¹à«àª‚ àª®àª¾àª°à«€ àªœàª®à«€àª¨àª¨à«€ àª¨àª¾àª‡àªŸà«àª°à«‹àªœàª¨ àª¸àª¾àª®àª—à«àª°à«€àª¨à«‡ àª•à«àª¦àª°àª¤à«€ àª°à«€àª¤à«‡ àª•à«‡àªµà«€ àª°à«€àª¤à«‡ àª¸à«àª§àª¾àª°à«€ àª¶àª•à«àª‚?",
                    askBtn: "àªªà«‚àª›à«‹",
                    selectDistrictError: "àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªàª• àªœàª¿àª²à«àª²à«‹ àªªàª¸àª‚àª¦ àª•àª°à«‹.",
                    fetchError: "àª®àª¾àª« àª•àª°àª¶à«‹, àª•à«ƒàª·àª¿ àª¡à«‡àªŸàª¾ àª®à«‡àª³àªµàª¤à«€ àªµàª–àª¤à«‡ àªàª• àª­à«‚àª² àª†àªµà«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª›à«€àª¥à«€ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.",
                    askError: "àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªàª• àªªà«àª°àª¶à«àª¨ àª¦àª¾àª–àª² àª•àª°à«‹ àª…àª¨à«‡ àªàª• àªœàª¿àª²à«àª²à«‹ àªªàª¸àª‚àª¦ àª•àª°à«‹.",
                    geminiError: "àª®àª¾àª« àª•àª°àª¶à«‹, àª¹à«àª‚ àª† àª¸àª®àª¯à«‡ àª•à«‹àªˆ àªªà«àª°àª¤àª¿àª­àª¾àªµ àª†àªªà«€ àª¶àª•àª¤à«‹ àª¨àª¥à«€. àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª›à«€àª¥à«€ àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸ àª•àª°à«‹.",
                    expertAdvicePrefix: "àª¨àª¿àª·à«àª£àª¾àª¤àª¨à«€ àª¸àª²àª¾àª¹:"
                }
            };

            let currentLang = 'en';

            // Function to set the language and update UI text
            function setLanguage(lang) {
                currentLang = lang;
                const t = translations[lang];

                // Update UI text
                websiteTitle.textContent = t.websiteTitle;
                document.getElementById('main-title').textContent = t.mainTitle;
                document.getElementById('main-subtitle').textContent = t.mainSubtitle;
                document.getElementById('district').options[0].textContent = t.districtPlaceholder;
                document.getElementById('get-info-btn').textContent = t.getInfoBtn;
                document.getElementById('loading-text').textContent = t.loadingText;
                document.getElementById('plants-heading').textContent = t.plantsHeading;
                document.getElementById('nutrients-heading').textContent = t.nutrientsHeading;
                document.getElementById('alerts-heading').textContent = t.alertsHeading;
                document.getElementById('expert-heading').textContent = t.expertHeading;
                document.getElementById('expert-subtitle').textContent = t.expertSubtitle;
                document.getElementById('user-question').placeholder = t.questionPlaceholder;
                document.getElementById('ask-button').textContent = t.askBtn;

                // Update button styles
                document.querySelectorAll('.flex.justify-end button').forEach(btn => {
                    btn.classList.remove('bg-gray-200', 'font-medium');
                });
                document.getElementById(`lang-${lang}`).classList.add('bg-gray-200', 'font-medium');

                // Clear any existing messages
                showMessage('', '');
            }

            // Set initial language to English
            setLanguage(currentLang);

            // Add event listeners for language buttons
            langEnBtn.addEventListener('click', () => setLanguage('en'));
            langHiBtn.addEventListener('click', () => setLanguage('hi'));
            langGuBtn.addEventListener('click', () => setLanguage('gu'));

            // Event listener for form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                
                // Clear previous results and messages
                clearResults();
                showMessage('', '');

                const district = districtInput.value.trim().toLowerCase();

                // Validation to ensure a district is selected
                if (district === '') {
                    showMessage(translations[currentLang].selectDistrictError, 'bg-red-200 text-red-800');
                    return;
                }

                // Show loading indicator
                loadingIndicator.classList.remove('hidden');

                // Construct a structured prompt for the Gemini API
                const prompt = `You are a helpful agricultural expert from the state of Gujarat, India. Provide agricultural information for the ${district} district of Gujarat. The information should be in a JSON object format and the text values should be in ${currentLang == 'hi' ? 'Hindi' : currentLang == 'gu' ? 'Gujarati' : 'English'}.
                
                The JSON object should have the following structure:
                {
                  "plants": ["list of recommended plants"],
                  "season": "main farming season(s)",
                  "nutrients": {
                    "nitrogen": "level (e.g., Low, Medium, High)",
                    "phosphorus": "level",
                    "potassium": "level",
                    "pH": "level (e.g., Alkaline, Slightly Acidic)"
                  },
                  "alerts": ["list of current weather or pest alerts"]
                }
                
                The information should be concise and relevant to the selected district.`;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { 
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json"
                        }
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const maxRetries = 3;
                    let retries = 0;
                    let response;
                    let data;

                    while (retries < maxRetries) {
                        try {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            
                            if (response.status === 429) {
                                retries++;
                                const delay = Math.pow(2, retries) * 1000;
                                await new Promise(res => setTimeout(res, delay));
                                continue;
                            }
                            if (!response.ok) {
                                throw new Error(`API call failed with status: ${response.status}`);
                            }
                            data = await response.json();
                            break; 
                        } catch (error) {
                            if (retries === maxRetries - 1) throw error;
                            retries++;
                        }
                    }

                    if (data.candidates && data.candidates.length > 0 &&
                        data.candidates[0].content && data.candidates[0].content.parts &&
                        data.candidates[0].content.parts.length > 0) {
                        const jsonText = data.candidates[0].content.parts[0].text;
                        const parsedData = JSON.parse(jsonText);
                        displayResults(parsedData);
                    } else {
                        throw new Error('No valid response from API.');
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    showMessage(translations[currentLang].fetchError, 'bg-red-200 text-red-800');
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            });

            // Event listener for the "Ask an Expert" button
            askButton.addEventListener('click', async () => {
                const question = userQuestionTextarea.value.trim();
                const district = districtInput.value;

                if (!question || district === '') {
                    showMessage(translations[currentLang].askError, 'bg-yellow-200 text-yellow-800');
                    return;
                }
                
                // Show Gemini response section and loading indicator
                geminiResponseDiv.classList.remove('hidden');
                geminiTextP.textContent = '';
                geminiLoadingDiv.classList.remove('hidden');
                showMessage('', '');

                // Construct the prompt for the Gemini API
                const prompt = `You are a helpful agricultural expert from the state of Gujarat, India. A farmer from ${district} has a question. Answer their question based on your expertise. Be concise and use a friendly tone. Provide your answer in ${currentLang == 'hi' ? 'Hindi' : currentLang == 'gu' ? 'Gujarati' : 'English'}.

                Farmer's Question: ${question}
                
                Provide your answer, starting with '${translations[currentLang].expertAdvicePrefix}'.`;

                try {
                    // Call the Gemini API
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    // Simple retry logic with exponential backoff
                    const maxRetries = 3;
                    let retries = 0;
                    let response;
                    while (retries < maxRetries) {
                        try {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (response.status === 429) {
                                // Too many requests, retry with backoff
                                retries++;
                                const delay = Math.pow(2, retries) * 1000;
                                await new Promise(res => setTimeout(res, delay));
                                continue;
                            }
                            if (!response.ok) {
                                throw new Error(`API call failed with status: ${response.status}`);
                            }
                            break; // Success
                        } catch (error) {
                            if (retries === maxRetries - 1) throw error;
                            retries++;
                        }
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        geminiTextP.textContent = text;
                    } else {
                        throw new Error('No valid response from API.');
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    geminiTextP.textContent = translations[currentLang].geminiError;
                    showMessage(translations[currentLang].fetchError, 'bg-red-200 text-red-800');
                } finally {
                    geminiLoadingDiv.classList.add('hidden');
                }
            });

            // Function to display the fetched data
            function displayResults(data) {
                // Clear previous content
                plantInfoDiv.innerHTML = '';
                nutrientInfoDiv.innerHTML = '';
                alertInfoDiv.innerHTML = '';
                
                const t = translations[currentLang];

                // Display plant recommendations
                const plantsHtml = data.plants.map(plant => `<p class="flex items-center"><span class="text-green-500 mr-2">âœ“</span> ${plant}</p>`).join('');
                plantInfoDiv.innerHTML = plantsHtml;
                plantInfoDiv.innerHTML += `<p class="mt-2 text-gray-500 text-sm">${t.plantsHeading.replace('Recommended Plants', 'Best season')}: <span class="font-semibold">${data.season}</span></p>`;

                // Display soil nutrient information
                const nutrientsHtml = Object.entries(data.nutrients).map(([key, value]) => `
                    <p class="capitalize"><strong>${key}:</strong> ${value}</p>
                `).join('');
                nutrientInfoDiv.innerHTML = nutrientsHtml;

                // Display alerts
                const alertsHtml = data.alerts.map(alert => `
                    <p class="flex items-center text-red-600 font-medium">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856a2 2 0 001.789-2.846L12.93 3.518a2 2 0 00-3.58 0L3.34 16.154a2 2 0 001.789 2.846z"></path>
                        </svg>
                        <span>${alert}</span>
                    </p>
                `).join('');
                alertInfoDiv.innerHTML = alertsHtml;

                // Show the results section
                resultsDiv.classList.remove('hidden');
            }

            // Function to show a message in the message box
            function showMessage(message, classes) {
                messageBox.textContent = message;
                messageBox.className = `p-4 mt-4 text-center rounded-lg ${classes}`;
                if (message) {
                    messageBox.classList.remove('hidden');
                } else {
                    messageBox.classList.add('hidden');
                }
            }

            // Function to clear results
            function clearResults() {
                resultsDiv.classList.add('hidden');
                plantInfoDiv.innerHTML = '';
                nutrientInfoDiv.innerHTML = '';
                alertInfoDiv.innerHTML = '';
            }
        });
    </script>
</body>
</html>
